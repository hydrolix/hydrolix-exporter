apiVersion: v1
kind: ConfigMap
metadata:
  name: otelcol-hydrolix-config
  namespace: your-namespace
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1000

    exporters:
      hydrolix/metrics:
        endpoint: ${HYDROLIX_ENDPOINT}
        hdx_table: your_project.metrics_table
        hdx_transform: your_metrics_transform
        hdx_bearer_token: ${HYDROLIX_BEARER_TOKEN}
        timeout: 30s

      hydrolix/traces:
        endpoint: ${HYDROLIX_ENDPOINT}
        hdx_table: your_project.traces_table
        hdx_transform: your_traces_transform
        hdx_bearer_token: ${HYDROLIX_BEARER_TOKEN}
        timeout: 30s

      hydrolix/logs:
        endpoint: ${HYDROLIX_ENDPOINT}
        hdx_table: your_project.logs_table
        hdx_transform: your_logs_transform
        hdx_bearer_token: ${HYDROLIX_BEARER_TOKEN}
        timeout: 30s

    service:
      telemetry:
        logs:
          level: info
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [hydrolix/traces]
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [hydrolix/metrics]
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [hydrolix/logs]

---
apiVersion: v1
kind: Secret
metadata:
  name: hydrolix-credentials
  namespace: your-namespace
type: Opaque
stringData:
  endpoint: "https://your-cluster.hydrolix.live/ingest/event"
  hdx_bearer_token: "your-bearer-token-here"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otelcol-hydrolix
  namespace: your-namespace
spec:
  replicas: 1
  selector:
    matchLabels:
      app: otelcol-hydrolix
  template:
    metadata:
      labels:
        app: otelcol-hydrolix
    spec:
      containers:
        - name: otelcol
          image: us-docker.pkg.dev/hdx-art/t/hdx-collector:1.0.0
          ports:
            - containerPort: 4317
              name: otlp-grpc
              protocol: TCP
            - containerPort: 4318
              name: otlp-http
              protocol: TCP
          resources:
            limits:
              memory: 512Mi
              cpu: 500m
            requests:
              memory: 256Mi
              cpu: 100m
          env:
            - name: HYDROLIX_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: hydrolix-credentials
                  key: endpoint
            - name: HYDROLIX_BEARER_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hydrolix-credentials
                  key: hdx_bearer_token
          volumeMounts:
            - name: config
              mountPath: /etc/otelcol/config.yaml
              subPath: config.yaml
      volumes:
        - name: config
          configMap:
            name: otelcol-hydrolix-config

---
apiVersion: v1
kind: Service
metadata:
  name: otelcol-hydrolix
  namespace: your-namespace
spec:
  type: ClusterIP
  selector:
    app: otelcol-hydrolix
  ports:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP
